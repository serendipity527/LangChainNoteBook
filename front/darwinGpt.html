<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darwin GPT - AI 智能助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #212121;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 260px;
            background-color: #171717;
            border-right: 1px solid #2d2d2d;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #2d2d2d;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background-color: transparent;
            border: 1px solid #4d4d4d;
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background-color: #2d2d2d;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 12px 16px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #b3b3b3;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item:hover {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .chat-item.active {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        /* 主聊天区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #212121;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #2d2d2d;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
        }

        .menu-toggle:hover {
            background-color: #2d2d2d;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 16px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-avatar {
            background-color: #10a37f;
            color: #ffffff;
        }

        .ai-avatar {
            background-color: #ab68ff;
            color: #ffffff;
        }

        .message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 15px;
        }

        .user .message-content {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .ai .message-content {
            background-color: #1a1a1a;
            color: #ffffff;
            border: 1px solid #2d2d2d;
        }

        /* 输入区域 */
        .input-area {
            padding: 24px;
            border-top: 1px solid #2d2d2d;
            background-color: #212121;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 12px 16px;
            gap: 12px;
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 24px;
        }

        .message-input::placeholder {
            color: #8e8e8e;
        }

        .send-btn {
            width: 32px;
            height: 32px;
            background-color: #10a37f;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            background-color: #0d8f6f;
        }

        .send-btn:disabled {
            background-color: #4d4d4d;
            cursor: not-allowed;
        }

        /* 加载动画 */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #8e8e8e;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 记忆模式切换 */
        .memory-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 8px 16px;
            background-color: #2d2d2d;
            border-radius: 8px;
            border: 1px solid #4d4d4d;
        }

        .memory-toggle label {
            font-size: 14px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .memory-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background-color: #4d4d4d;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .memory-switch.active {
            background-color: #10a37f;
        }

        .memory-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background-color: #ffffff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .memory-switch.active::before {
            transform: translateX(20px);
        }

        .memory-status {
            font-size: 12px;
            color: #8e8e8e;
            margin-left: auto;
        }

        /* 模型选择器 */
        .model-selector {
            margin-bottom: 16px;
            padding: 8px 16px;
            background-color: #2d2d2d;
            border-radius: 8px;
            border: 1px solid #4d4d4d;
        }

        .model-selector label {
            font-size: 14px;
            color: #ffffff;
            display: block;
            margin-bottom: 8px;
        }

        .model-select {
            width: 100%;
            padding: 8px 12px;
            background-color: #1a1a1a;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .model-select:hover {
            border-color: #6d6d6d;
        }

        .model-select:focus {
            outline: none;
            border-color: #10a37f;
        }

        .model-select option {
            background-color: #1a1a1a;
            color: #ffffff;
            padding: 8px;
        }

        .model-info {
            font-size: 12px;
            color: #8e8e8e;
            margin-top: 4px;
            line-height: 1.3;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-toggle {
                display: block;
            }

            .chat-messages {
                padding: 16px;
            }

            .input-area {
                padding: 16px;
            }

            .message {
                gap: 12px;
            }
        }

        /* 滚动条样式 */
        .chat-messages::-webkit-scrollbar,
        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .chat-history::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .chat-history::-webkit-scrollbar-thumb {
            background-color: #4d4d4d;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .chat-history::-webkit-scrollbar-thumb:hover {
            background-color: #6d6d6d;
        }

        /* 欢迎界面 */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 24px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #10a37f, #ab68ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #8e8e8e;
            margin-bottom: 32px;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            max-width: 800px;
            width: 100%;
        }

        .example-prompt {
            padding: 16px;
            background-color: #2d2d2d;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .example-prompt:hover {
            background-color: #3d3d3d;
            border-color: #4d4d4d;
        }

        .example-prompt h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .example-prompt p {
            font-size: 14px;
            color: #b3b3b3;
            line-height: 1.4;
        }

        /* 连接状态指示器 */
        .connection-status {
            position: fixed;
            top: 16px;
            right: 16px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status.connected {
            background-color: rgba(16, 163, 127, 0.2);
            color: #10a37f;
            border: 1px solid rgba(16, 163, 127, 0.3);
        }

        .connection-status.disconnected {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .connection-status.checking {
            background-color: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .status-dot.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- 连接状态指示器 -->
    <div class="connection-status checking" id="connectionStatus">
        <div class="status-dot pulse"></div>
        <span>检查连接...</span>
    </div>

    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <!-- 模型选择器 -->
                <div class="model-selector">
                    <label for="modelSelect">🤖 选择模型</label>
                    <select class="model-select" id="modelSelect" onchange="onModelChange()">
                        <option value="qwen3:0.6b">加载中...</option>
                    </select>
                    <div class="model-info" id="modelInfo">正在加载模型信息...</div>
                </div>

                <!-- 记忆模式切换 -->
                <div class="memory-toggle">
                    <label>
                        🧠 记忆模式
                    </label>
                    <div class="memory-switch active" id="memorySwitch" onclick="toggleMemoryMode()"></div>
                    <span class="memory-status" id="memoryStatus">开启</span>
                </div>

                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>➕</span>
                    新建聊天
                </button>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- 聊天历史将在这里动态生成 -->
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="chat-header">
                <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
                <div class="chat-title" id="chatTitle">Darwin GPT</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- 欢迎界面 -->
                <div class="welcome-screen" id="welcomeScreen">
                    <h1 class="welcome-title">Darwin GPT</h1>
                    <p class="welcome-subtitle">您的AI智能助手，随时为您提供帮助</p>
                    <div class="example-prompts">
                        <div class="example-prompt" onclick="useExamplePrompt('解释一下人工智能的基本概念')">
                            <h3>💡 学习助手</h3>
                            <p>解释一下人工智能的基本概念</p>
                        </div>
                        <div class="example-prompt" onclick="useExamplePrompt('帮我写一个Python函数来计算斐波那契数列')">
                            <h3>💻 编程助手</h3>
                            <p>帮我写一个Python函数来计算斐波那契数列</p>
                        </div>
                        <div class="example-prompt" onclick="useExamplePrompt('给我一些提高工作效率的建议')">
                            <h3>🚀 生活助手</h3>
                            <p>给我一些提高工作效率的建议</p>
                        </div>
                        <div class="example-prompt" onclick="useExamplePrompt('帮我分析一下当前的科技趋势')">
                            <h3>📊 分析助手</h3>
                            <p>帮我分析一下当前的科技趋势</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea
                            class="message-input"
                            id="messageInput"
                            placeholder="输入您的消息..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <span>➤</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局变量
        let currentChatId = null;
        let chatHistory = JSON.parse(localStorage.getItem('darwinGptHistory') || '[]');
        let isTyping = false;
        let connectionStatus = 'checking'; // checking, connected, disconnected
        let connectionCheckInterval = null;
        let memoryMode = true; // 记忆模式，默认开启
        let availableModels = {}; // 可用模型列表
        let selectedModel = 'qwen3:0.6b'; // 当前选中的模型

        // 配置 axios 默认设置
        axios.defaults.baseURL = 'http://localhost:8000';
        axios.defaults.timeout = 30000;
        axios.defaults.headers.common['Content-Type'] = 'application/json';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();
            adjustTextareaHeight(document.getElementById('messageInput'));
            checkConnection();
            startConnectionMonitoring();
            initializeMemoryMode(); // 初始化记忆模式设置
            loadAvailableModels(); // 加载可用模型列表
            initializeModelSelector(); // 初始化模型选择器
        });

        // 切换侧边栏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // 开始新聊天
        function startNewChat() {
            // 如果是记忆模式，生成新的聊天ID
            if (memoryMode) {
                currentChatId = generateChatId();
            } else {
                currentChatId = null; // 无记忆模式不需要聊天ID
            }
            
            const chatMessages = document.getElementById('chatMessages');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatTitle = document.getElementById('chatTitle');

            chatMessages.innerHTML = '';
            welcomeScreen.style.display = 'flex';
            chatMessages.appendChild(welcomeScreen);
            chatTitle.textContent = 'Darwin GPT';

            // 更新聊天历史显示
            updateChatHistoryDisplay();
        }

        // 生成聊天ID
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 使用示例提示
        function useExamplePrompt(prompt) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = prompt;
            adjustTextareaHeight(messageInput);
            sendMessage();
        }

        // 处理键盘事件
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 调整文本框高度
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // 发送消息
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || isTyping) return;

            // 验证消息长度
            if (message.length > 4000) {
                alert('消息太长了，请缩短后再试（最多4000字符）');
                return;
            }

            // 如果是新聊天，隐藏欢迎界面
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
            }

            // 添加用户消息
            addMessage('user', message);
            messageInput.value = '';
            adjustTextareaHeight(messageInput);

            // 保存到聊天历史
            saveChatMessage('user', message);

            // 显示AI正在输入
            showTypingIndicator();

            try {
                const response = await callAIAPI(message);
                hideTypingIndicator();

                if (response && response.trim()) {
                    addMessage('ai', response);
                    saveChatMessage('ai', response);
                } else {
                    addMessage('ai', '抱歉，我没有收到有效的回复。请重新提问。');
                }
            } catch (error) {
                hideTypingIndicator();

                // 显示具体的错误信息给用户
                let errorMessage = '抱歉，我现在无法回复。';
                if (error.message) {
                    errorMessage = error.message;
                }

                addMessage('ai', errorMessage);
                console.error('API调用失败:', error);

                // 如果是网络错误，提供重试选项
                if (error.message.includes('网络') || error.message.includes('连接')) {
                    setTimeout(() => {
                        if (confirm('网络连接似乎有问题，是否要重试发送这条消息？')) {
                            // 重新设置输入框内容并重试
                            messageInput.value = message;
                            adjustTextareaHeight(messageInput);
                        }
                    }, 1000);
                }
            }
        }

        // 添加消息到聊天界面
        function addMessage(sender, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${sender}-avatar`;
            avatar.textContent = sender === 'user' ? 'U' : 'AI';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            if (sender === 'ai') {
                // AI消息使用打字机效果
                typeWriter(messageContent, content);
            } else {
                messageContent.textContent = content;
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 打字机效果
        function typeWriter(element, text, speed = 30) {
            let i = 0;
            element.textContent = '';

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);

                    // 滚动到底部
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            type();
        }

        // 显示输入指示器
        function showTypingIndicator() {
            isTyping = true;
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');

            // 禁用发送按钮和输入框
            sendBtn.disabled = true;
            messageInput.disabled = true;

            // 更改发送按钮样式以显示加载状态
            sendBtn.innerHTML = '<span style="animation: spin 1s linear infinite;">⟳</span>';

            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar ai-avatar';
            avatar.textContent = 'AI';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';

            // 添加状态文本
            const statusText = document.createElement('div');
            statusText.style.fontSize = '12px';
            statusText.style.color = '#8e8e8e';
            statusText.style.marginTop = '4px';
            statusText.textContent = 'AI正在思考...';

            messageContent.appendChild(typingIndicator);
            messageContent.appendChild(statusText);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(messageContent);
            chatMessages.appendChild(typingDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 隐藏输入指示器
        function hideTypingIndicator() {
            isTyping = false;
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');

            // 恢复发送按钮和输入框
            sendBtn.disabled = false;
            messageInput.disabled = false;
            sendBtn.innerHTML = '<span>➤</span>';

            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 调用AI API
        async function callAIAPI(message, retryCount = 0) {
            const maxRetries = 3;

            try {
                // 根据记忆模式选择不同的接口
                const endpoint = memoryMode ? '/chat/memory' : '/chat/once';
                
                const requestBody = {
                    message: message,
                    model_key: selectedModel // 添加选中的模型
                };

                // 如果是记忆模式，添加聊天ID和记忆类型
                if (memoryMode) {
                    if (!currentChatId) {
                        currentChatId = generateChatId();
                    }
                    requestBody.chat_id = currentChatId;
                    requestBody.memory_type = 'buffer'; // 默认使用buffer记忆类型
                }

                const response = await axios.post(endpoint, requestBody);

                if (connectionStatus !== 'connected') {
                    updateConnectionStatus('connected', '已连接');
                }

                return response.data.response || '抱歉，我无法生成回复。';

            } catch (error) {
                console.error('API调用失败:', error);

                if (error.code === 'ECONNABORTED') {
                    throw new Error('请求超时，请检查网络连接或稍后再试');
                }

                if (error.response) {
                    // 服务器响应错误
                    let errorMessage = `服务器错误 (${error.response.status})`;

                    switch (error.response.status) {
                        case 400:
                            errorMessage = '请求格式错误，请重试';
                            break;
                        case 401:
                            errorMessage = '未授权访问，请检查权限';
                            break;
                        case 403:
                            errorMessage = '访问被禁止';
                            break;
                        case 404:
                            errorMessage = '聊天服务未找到，请检查后端服务';
                            break;
                        case 429:
                            errorMessage = '请求过于频繁，请稍后再试';
                            break;
                        case 500:
                            errorMessage = '服务器内部错误，请稍后再试';
                            break;
                        case 502:
                        case 503:
                        case 504:
                            errorMessage = '服务暂时不可用，请稍后再试';
                            break;
                    }

                    throw new Error(errorMessage);
                } else if (error.request) {
                    // 网络错误
                    updateConnectionStatus('disconnected', '连接断开');

                    if (retryCount < maxRetries) {
                        console.log(`网络错误，正在重试... (${retryCount + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                        return callAIAPI(message, retryCount + 1);
                    } else {
                        throw new Error('网络连接失败，请检查网络连接后重试');
                    }
                }

                throw error;
            }
        }

        // 保存聊天消息
        function saveChatMessage(sender, content) {
            // 只有在记忆模式下才保存到本地历史
            if (!memoryMode) {
                return; // 无记忆模式不保存历史
            }

            if (!currentChatId) {
                currentChatId = generateChatId();
            }

            let chat = chatHistory.find(c => c.id === currentChatId);
            if (!chat) {
                chat = {
                    id: currentChatId,
                    title: content.substring(0, 30) + (content.length > 30 ? '...' : ''),
                    messages: [],
                    timestamp: Date.now()
                };
                chatHistory.unshift(chat);
            }

            chat.messages.push({
                sender: sender,
                content: content,
                timestamp: Date.now()
            });

            // 更新聊天标题（使用第一条用户消息）
            if (sender === 'user' && chat.messages.filter(m => m.sender === 'user').length === 1) {
                chat.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                document.getElementById('chatTitle').textContent = chat.title;
            }

            localStorage.setItem('darwinGptHistory', JSON.stringify(chatHistory));
            updateChatHistoryDisplay();
        }

        // 加载聊天历史
        function loadChatHistory() {
            updateChatHistoryDisplay();
        }

        // 更新聊天历史显示
        function updateChatHistoryDisplay() {
            const chatHistoryDiv = document.getElementById('chatHistory');
            chatHistoryDiv.innerHTML = '';

            chatHistory.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                if (chat.id === currentChatId) {
                    chatItem.classList.add('active');
                }
                chatItem.textContent = chat.title;
                chatItem.onclick = () => loadChat(chat.id);
                chatHistoryDiv.appendChild(chatItem);
            });
        }

        // 加载特定聊天
        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            const chatMessages = document.getElementById('chatMessages');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const chatTitle = document.getElementById('chatTitle');

            chatMessages.innerHTML = '';
            welcomeScreen.style.display = 'none';
            chatTitle.textContent = chat.title;

            // 重新显示所有消息
            chat.messages.forEach(msg => {
                addMessageInstant(msg.sender, msg.content);
            });

            updateChatHistoryDisplay();

            // 在移动端关闭侧边栏
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        // 立即添加消息（不使用打字机效果）
        function addMessageInstant(sender, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${sender}-avatar`;
            avatar.textContent = sender === 'user' ? 'U' : 'AI';

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 响应式处理
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        });

        // 点击外部关闭侧边栏（移动端）
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.querySelector('.menu-toggle');

            if (window.innerWidth <= 768 &&
                sidebar.classList.contains('open') &&
                !sidebar.contains(event.target) &&
                !menuToggle.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        // 连接状态管理
        function updateConnectionStatus(status, message) {
            connectionStatus = status;
            const statusElement = document.getElementById('connectionStatus');
            const statusDot = statusElement.querySelector('.status-dot');
            const statusText = statusElement.querySelector('span');

            // 移除所有状态类
            statusElement.classList.remove('connected', 'disconnected', 'checking');
            statusDot.classList.remove('pulse');

            // 添加新状态类
            statusElement.classList.add(status);
            statusText.textContent = message;

            if (status === 'checking') {
                statusDot.classList.add('pulse');
            }

            // 如果连接成功，3秒后隐藏状态指示器
            if (status === 'connected') {
                setTimeout(() => {
                    statusElement.style.opacity = '0.7';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 300);
                }, 3000);
            } else {
                statusElement.style.display = 'flex';
                statusElement.style.opacity = '1';
            }
        }

        // 检查连接状态
        async function checkConnection() {
            try {
                updateConnectionStatus('checking', '检查连接...');

                const response = await axios.get('/health');

                if (response.status === 200) {
                    updateConnectionStatus('connected', '已连接');
                } else {
                    updateConnectionStatus('disconnected', '连接失败');
                }
            } catch (error) {
                updateConnectionStatus('disconnected', '连接失败');
                console.error('连接检查失败:', error);
            }
        }

        // 开始连接监控
        function startConnectionMonitoring() {
            // 每30秒检查一次连接
            connectionCheckInterval = setInterval(checkConnection, 30000);
        }

        // 停止连接监控
        function stopConnectionMonitoring() {
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
                connectionCheckInterval = null;
            }
        }

        // 页面卸载时停止监控
        window.addEventListener('beforeunload', stopConnectionMonitoring);

        // 切换记忆模式
        function toggleMemoryMode() {
            memoryMode = !memoryMode;
            const memorySwitch = document.getElementById('memorySwitch');
            const memoryStatus = document.getElementById('memoryStatus');
            
            if (memoryMode) {
                memorySwitch.classList.add('active');
                memoryStatus.textContent = '开启';
            } else {
                memorySwitch.classList.remove('active');
                memoryStatus.textContent = '关闭';
            }
            
            // 保存设置到本地存储
            localStorage.setItem('darwinGptMemoryMode', memoryMode.toString());
            
            // 如果当前有对话，提示用户模式已切换
            if (currentChatId && chatHistory.find(c => c.id === currentChatId)?.messages.length > 0) {
                const modeText = memoryMode ? '记忆模式' : '无记忆模式';
                console.log(`已切换到${modeText}，新消息将使用新模式`);
                
                // 可选：在界面上显示切换提示
                showModeChangeNotification(modeText);
            }
        }

        // 显示模式切换通知（可选功能）
        function showModeChangeNotification(modeText) {
            // 创建临时通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                transition: opacity 0.3s ease;
            `;
            notification.textContent = `已切换到${modeText}`;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除通知
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 初始化记忆模式设置
        function initializeMemoryMode() {
            const savedMode = localStorage.getItem('darwinGptMemoryMode');
            if (savedMode !== null) {
                memoryMode = savedMode === 'true';
            }

            const memorySwitch = document.getElementById('memorySwitch');
            const memoryStatus = document.getElementById('memoryStatus');

            if (memoryMode) {
                memorySwitch.classList.add('active');
                memoryStatus.textContent = '开启';
            } else {
                memorySwitch.classList.remove('active');
                memoryStatus.textContent = '关闭';
            }

            console.log(`记忆模式初始化: ${memoryMode ? '开启' : '关闭'}`);
        }

        // 加载可用模型列表
        async function loadAvailableModels() {
            try {
                const response = await axios.get('/chat/models');

                availableModels = response.data.models;
                updateModelSelector();
            } catch (error) {
                console.error('加载模型列表失败:', error);
                // 使用默认模型
                availableModels = {
                    'qwen3:0.6b': {
                        name: 'qwen3:0.6b',
                        provider: 'ollama',
                        description: '默认模型',
                        supports_memory: true
                    }
                };
                updateModelSelector();
            }
        }

        // 更新模型选择器
        function updateModelSelector() {
            const modelSelect = document.getElementById('modelSelect');
            const modelInfo = document.getElementById('modelInfo');

            // 清空现有选项
            modelSelect.innerHTML = '';

            // 添加模型选项
            Object.keys(availableModels).forEach(modelKey => {
                const model = availableModels[modelKey];
                const option = document.createElement('option');
                option.value = modelKey;
                option.textContent = model.name;
                if (modelKey === selectedModel) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });

            // 更新模型信息显示
            updateModelInfo();
        }

        // 更新模型信息显示
        function updateModelInfo() {
            const modelInfo = document.getElementById('modelInfo');
            const model = availableModels[selectedModel];

            if (model) {
                const memoryText = model.supports_memory ? '支持记忆' : '不支持记忆';
                modelInfo.textContent = `${model.provider} | ${model.description} | ${memoryText}`;
            } else {
                modelInfo.textContent = '模型信息不可用';
            }
        }

        // 初始化模型选择器
        function initializeModelSelector() {
            const savedModel = localStorage.getItem('darwinGptSelectedModel');
            if (savedModel && availableModels[savedModel]) {
                selectedModel = savedModel;
            }
        }

        // 模型选择变化处理
        function onModelChange() {
            const modelSelect = document.getElementById('modelSelect');
            selectedModel = modelSelect.value;

            // 保存选择到本地存储
            localStorage.setItem('darwinGptSelectedModel', selectedModel);

            // 更新模型信息显示
            updateModelInfo();

            // 如果当前有对话，提示用户新模型将在下次消息中生效
            if (currentChatId && chatHistory.find(c => c.id === currentChatId)?.messages.length > 0) {
                console.log(`已切换到模型: ${selectedModel}，新消息将使用新模型`);
            }
        }
    </script>
</body>
</html>

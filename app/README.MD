æˆ‘æ¥å¸®æ‚¨åˆ†æ `/app` ç›®å½•ä¸‹çš„é¡¹ç›®ç»“æ„å’Œå†…å®¹ã€‚è®©æˆ‘å…ˆæŸ¥çœ‹ä¸€ä¸‹é¡¹ç›®çš„æ•´ä½“ç»“æ„ã€‚

ç°åœ¨è®©æˆ‘æŸ¥çœ‹ä¸»è¦çš„æ–‡ä»¶å†…å®¹æ¥äº†è§£é¡¹ç›®çš„æ¶æ„å’ŒåŠŸèƒ½ï¼š

ç°åœ¨è®©æˆ‘æŸ¥çœ‹é¡¹ç›®çš„æ ¹ç›®å½•ç»“æ„ï¼Œäº†è§£æ•´ä¸ªé¡¹ç›®çš„ç»„ç»‡ï¼š

è®©æˆ‘æŸ¥çœ‹é¡¹ç›®çš„ä¾èµ–é…ç½®æ–‡ä»¶ï¼š

ç°åœ¨è®©æˆ‘æŸ¥çœ‹å‰ç«¯æ–‡ä»¶ï¼š

åŸºäºæˆ‘å¯¹ `/app` ç›®å½•çš„åˆ†æï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº **LangChain** å’Œ **FastAPI** æ„å»ºçš„æ™ºèƒ½èŠå¤©åº”ç”¨é¡¹ç›®ã€‚è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†åˆ†æé¡¹ç›®çš„æ¶æ„å’ŒåŠŸèƒ½ï¼š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ AI èŠå¤©åº”ç”¨ï¼Œé‡‡ç”¨äº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ”¯æŒå¤šæ¨¡å‹ã€å¤šè®°å¿†æ¨¡å¼çš„å¯¹è¯åŠŸèƒ½ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### 1. **æ ¸å¿ƒæŠ€æœ¯æ ˆ**
- **åç«¯æ¡†æ¶**: FastAPI
- **AIæ¡†æ¶**: LangChain + LCEL (LangChain Expression Language)
- **æ¨¡å‹æ”¯æŒ**: Ollama (æœ¬åœ°æ¨¡å‹)
- **å‰ç«¯**: åŸç”Ÿ HTML/CSS/JavaScript
- **åŒ…ç®¡ç†**: UV (ç°ä»£ Python åŒ…ç®¡ç†å™¨)

### 2. **ç›®å½•ç»“æ„åˆ†æ**

```` path=app mode=EXCERPT
app/
â”œâ”€â”€ main.py              # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ api/                 # API è·¯ç”±å±‚
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ chat.py      # èŠå¤©ç›¸å…³è·¯ç”±
â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ chat_models.py   # Pydantic æ¨¡å‹å®šä¹‰
â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ chat_service.py  # èŠå¤©æœåŠ¡
â”‚   â””â”€â”€ model_factory.py # æ¨¡å‹å·¥å‚
â”œâ”€â”€ chains/              # LangChain é“¾å®ç°
â”‚   â”œâ”€â”€ base_chain.py    # æŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ chain_factory.py # é“¾å·¥å‚
â”‚   â”œâ”€â”€ memory_chain.py  # è®°å¿†é“¾
â”‚   â””â”€â”€ stateless_chain.py # æ— çŠ¶æ€é“¾
â””â”€â”€ config/              # é…ç½®ç®¡ç†
    â””â”€â”€ model_config.py  # æ¨¡å‹é…ç½®
````

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. **å¤šæ¨¡å‹æ”¯æŒ**
é¡¹ç›®æ”¯æŒå¤šä¸ª Ollama æœ¬åœ°æ¨¡å‹ï¼š

````python path=app/config/model_config.py mode=EXCERPT
MODEL_CONFIGS: Dict[str, ModelConfig] = {
    "qwen3:0.6b": ModelConfig(
        name="qwen3:0.6b",
        provider=ModelProvider.OLLAMA,
        model_id="qwen3:0.6b",
        base_url="http://localhost:11434",
        description="tool,thinking,è½»é‡"
    ),
    "gemma3:4b": ModelConfig(...),
    "qwen3:4b": ModelConfig(...),
    "qwen2.5:3b": ModelConfig(...)
}
````

### 2. **åŒæ¨¡å¼å¯¹è¯**

#### **æ— è®°å¿†æ¨¡å¼** (StatelessChain)
- å•æ¬¡å¯¹è¯ï¼Œä¸ä¿å­˜å†å²
- é€‚åˆç‹¬ç«‹é—®ç­”åœºæ™¯

````python path=app/chains/stateless_chain.py mode=EXCERPT
async def invoke(self, request: ChatRequest, model_key: str = "qwen3:0.6b", **kwargs) -> ChatResponse:
    """æ‰§è¡Œæ— è®°å¿†å¯¹è¯"""
    chain = self._get_or_create_chain(model_key)
    response = await chain.ainvoke({"input": request.message})
    return ChatResponse(response=response, model_used=model_key, has_memory=False)
````

#### **è®°å¿†æ¨¡å¼** (MemoryChain)
- æ”¯æŒä¸¤ç§è®°å¿†ç±»å‹ï¼š
  - **Buffer Memory**: ä¿å­˜å®Œæ•´å¯¹è¯å†å²
  - **Summary Memory**: æ™ºèƒ½æ‘˜è¦é•¿å¯¹è¯

````python path=app/chains/memory_chain.py mode=EXCERPT
def _get_or_create_memory(self, chat_id: str, memory_type: str = "buffer", model_key: str = "qwen3:0.6b") -> BaseMemory:
    if memory_type == "buffer":
        self.memory_storage[memory_key] = ConversationBufferMemory(...)
    elif memory_type == "summary":
        self.memory_storage[memory_key] = ConversationSummaryBufferMemory(...)
````

### 3. **RESTful API æ¥å£**

````python path=app/api/routes/chat.py mode=EXCERPT
@router.post("/once", response_model=ChatResponse)
async def chat_once(chat_request: ChatRequest):
    """æ— è®°å¿†å•æ¬¡å¯¹è¯"""

@router.post("/memory", response_model=ChatResponse)
async def chat_with_memory(chat_request: ChatRequest):
    """å¸¦è®°å¿†çš„å¯¹è¯"""

@router.get("/models", response_model=ModelListResponse)
async def get_models():
    """è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨"""
````

## ğŸ¨ è®¾è®¡æ¨¡å¼

### 1. **å·¥å‚æ¨¡å¼**
- `ModelFactory`: ç»Ÿä¸€åˆ›å»ºä¸åŒæ¨¡å‹å®ä¾‹
- `ChainFactory`: ç®¡ç†ä¸åŒç±»å‹çš„å¯¹è¯é“¾

### 2. **ç­–ç•¥æ¨¡å¼**
- `BaseChain`: å®šä¹‰å¯¹è¯å¤„ç†æ¥å£
- ä¸åŒé“¾å®ç°ä¸åŒçš„å¯¹è¯ç­–ç•¥

### 3. **å•ä¾‹æ¨¡å¼**
- é“¾å®ä¾‹é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œæé«˜æ€§èƒ½

## ğŸŒŸ æŠ€æœ¯äº®ç‚¹

### 1. **LCEL (LangChain Expression Language)**
ä½¿ç”¨ç°ä»£åŒ–çš„é“¾å¼è¯­æ³•æ„å»ºå¤„ç†æµç¨‹ï¼š

````python path=app/chains/stateless_chain.py mode=EXCERPT
self.chains[model_key] = (
    RunnablePassthrough()
    | prompt
    | model
    | StrOutputParser()
)
````

### 2. **å¼‚æ­¥å¤„ç†**
å…¨é¢æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œæé«˜å¹¶å‘æ€§èƒ½

### 3. **ç±»å‹å®‰å…¨**
ä½¿ç”¨ Pydantic æ¨¡å‹ç¡®ä¿æ•°æ®ç±»å‹å®‰å…¨

### 4. **é…ç½®åŒ–è®¾è®¡**
æ¨¡å‹é…ç½®é›†ä¸­ç®¡ç†ï¼Œæ˜“äºæ‰©å±•

## ğŸ”§ æ‰©å±•æ€§

é¡¹ç›®å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼š
- **æ–°æ¨¡å‹**: åœ¨ `model_config.py` ä¸­æ·»åŠ é…ç½®ï¼Œåœ¨ `ModelFactory` ä¸­å®ç°
- **æ–°é“¾ç±»å‹**: ç»§æ‰¿ `BaseChain` å®ç°æ–°çš„å¯¹è¯ç­–ç•¥
- **æ–°API**: åœ¨ `routes` ç›®å½•ä¸‹æ·»åŠ æ–°çš„è·¯ç”±æ¨¡å—

## ğŸ“± å‰ç«¯ç•Œé¢

é¡¹ç›®åŒ…å«ä¸€ä¸ªç°ä»£åŒ–çš„èŠå¤©ç•Œé¢ (`front/darwinGpt.html`)ï¼Œå…·æœ‰ï¼š
- æ·±è‰²ä¸»é¢˜è®¾è®¡
- å“åº”å¼å¸ƒå±€
- å®æ—¶å¯¹è¯åŠŸèƒ½
- æ¨¡å‹åˆ‡æ¢åŠŸèƒ½

## ğŸ¯ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªæ¶æ„æ¸…æ™°ã€åŠŸèƒ½å®Œæ•´çš„ AI èŠå¤©åº”ç”¨é¡¹ç›®ï¼Œå±•ç°äº†ï¼š
- **è‰¯å¥½çš„ä»£ç ç»„ç»‡**: åˆ†å±‚æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»
- **ç°ä»£åŒ–æŠ€æœ¯æ ˆ**: FastAPI + LangChain + LCEL
- **çµæ´»çš„è®¾è®¡**: æ”¯æŒå¤šæ¨¡å‹ã€å¤šè®°å¿†æ¨¡å¼
- **å¯æ‰©å±•æ€§**: å·¥å‚æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼çš„åº”ç”¨
- **ç±»å‹å®‰å…¨**: Pydantic æ¨¡å‹éªŒè¯

é¡¹ç›®é€‚åˆä½œä¸º LangChain åº”ç”¨å¼€å‘çš„å‚è€ƒå®ç°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºæ„å»ºæ›´å¤æ‚ AI åº”ç”¨çš„åŸºç¡€æ¡†æ¶ã€‚
